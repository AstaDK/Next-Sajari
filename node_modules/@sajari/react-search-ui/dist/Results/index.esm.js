import { useSearchContext, useQuery, useTracking } from '@sajari/react-hooks';
import { getStylesObject, isNullOrUndefined, isEmpty } from '@sajari/react-sdk-utils';
import { useMemo, useState, useEffect } from 'react';
import { useTranslation } from 'react-i18next';
import { jsx } from '@emotion/core/jsx-runtime';
import { useSearchUIContext } from '../ContextProvider/index.esm.js';
import { objectWithoutPropertiesLoose as _objectWithoutPropertiesLoose, extends as _extends } from '../_virtual/_rollupPluginBabelHelpers.js';
import { ResizeObserver } from '@sajari/react-components';
import _css from '@emotion/css';
import mapResultFields from '../utils/mapResultFields.esm.js';
import Message from './components/Message/index.esm.js';
import Result from './components/Result/index.esm.js';
import useResultsStyles from './styles.esm.js';

var Results = function Results(props) {
  var _customClassNames$res5;

  var _useSearchContext = useSearchContext(),
      rawResults = _useSearchContext.results,
      searching = _useSearchContext.searching,
      fields = _useSearchContext.fields,
      error = _useSearchContext.error;

  var results = useMemo(function () {
    return rawResults ? mapResultFields(rawResults, fields) : undefined;
  }, [rawResults]);

  var _useSearchUIContext = useSearchUIContext(),
      _useSearchUIContext$d = _useSearchUIContext.disableDefaultStyles,
      disableDefaultStyles = _useSearchUIContext$d === void 0 ? false : _useSearchUIContext$d,
      customClassNames = _useSearchUIContext.customClassNames,
      viewType = _useSearchUIContext.viewType,
      setViewType = _useSearchUIContext.setViewType;

  var _useQuery = useQuery(),
      query = _useQuery.query;

  var defaultAppearance = props.defaultAppearance,
      _props$appearance = props.appearance,
      appearance = _props$appearance === void 0 ? viewType : _props$appearance,
      stylesProp = props.styles,
      rest = _objectWithoutPropertiesLoose(props, ["defaultAppearance", "appearance", "styles"]);

  var _React$useState = useState(0),
      width = _React$useState[0],
      setWidth = _React$useState[1];

  var _useTracking = useTracking(),
      handleResultClicked = _useTracking.handleResultClicked;

  var hasImages = useMemo(function () {
    return results == null ? void 0 : results.some(function (r) {
      var _r$values;

      return (_r$values = r.values) == null ? void 0 : _r$values.image;
    });
  }, [results]);
  var styles = getStylesObject(useResultsStyles(_extends({}, props, {
    appearance: appearance,
    width: width
  })), disableDefaultStyles);

  var _useTranslation = useTranslation(['common', 'errors', 'result']),
      t = _useTranslation.t;

  useEffect(function () {
    if (defaultAppearance) {
      setViewType(defaultAppearance);
    }
  }, []);

  if (error) {
    var _customClassNames$res;

    var body = t('errors:generic');

    if (error.statusCode === 403) {
      body = t('errors:authorization');
    } else if (error.name === 'NetworkError' || error.message.startsWith('NetworkError')) {
      body = t('errors:connection');
    }

    return jsx(Message, {
      title: t('common:error'),
      body: body,
      className: (_customClassNames$res = customClassNames.results) == null ? void 0 : _customClassNames$res.errorMessage
    });
  }

  if (isNullOrUndefined(results)) {
    var _customClassNames$res2;

    return jsx(Message, {
      title: t('common:loading'),
      appearance: "loading",
      disableDefaultStyles: disableDefaultStyles,
      className: (_customClassNames$res2 = customClassNames.results) == null ? void 0 : _customClassNames$res2.searchingMessage
    });
  }

  if (isEmpty(results)) {
    var _customClassNames$res4;

    if (searching) {
      var _customClassNames$res3;

      return jsx(Message, {
        title: t('common:loading'),
        appearance: "loading",
        disableDefaultStyles: disableDefaultStyles,
        className: (_customClassNames$res3 = customClassNames.results) == null ? void 0 : _customClassNames$res3.searchingMessage
      });
    }

    return jsx(Message, {
      title: t('results:empty.title'),
      body: t('results:empty.body', {
        query: "<strong>" + query + "</strong>"
      }),
      disableDefaultStyles: disableDefaultStyles,
      className: (_customClassNames$res4 = customClassNames.results) == null ? void 0 : _customClassNames$res4.emptyMessage
    });
  }

  return jsx(ResizeObserver, {
    onResize: function onResize(rect) {
      return setWidth(rect.width);
    },
    css: /*#__PURE__*/_css([styles.container, stylesProp], ";label:Results;" + (process.env.NODE_ENV === "production" ? "" : "/*# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LnRzeCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUErQ3NFIiwiZmlsZSI6ImluZGV4LnRzeCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFJlc2l6ZU9ic2VydmVyIH0gZnJvbSAnQHNhamFyaS9yZWFjdC1jb21wb25lbnRzJztcclxuaW1wb3J0IHsgdXNlUXVlcnksIHVzZVNlYXJjaENvbnRleHQsIHVzZVRyYWNraW5nIH0gZnJvbSAnQHNhamFyaS9yZWFjdC1ob29rcyc7XHJcbmltcG9ydCB7IGdldFN0eWxlc09iamVjdCwgaXNFbXB0eSwgaXNOdWxsT3JVbmRlZmluZWQgfSBmcm9tICdAc2FqYXJpL3JlYWN0LXNkay11dGlscyc7XHJcbmltcG9ydCAqIGFzIFJlYWN0IGZyb20gJ3JlYWN0JztcclxuaW1wb3J0IHsgdXNlVHJhbnNsYXRpb24gfSBmcm9tICdyZWFjdC1pMThuZXh0JztcclxuaW1wb3J0IHsgdXNlU2VhcmNoVUlDb250ZXh0IH0gZnJvbSAnLi4vQ29udGV4dFByb3ZpZGVyJztcclxuaW1wb3J0IG1hcFJlc3VsdEZpZWxkcyBmcm9tICcuLi91dGlscy9tYXBSZXN1bHRGaWVsZHMnO1xyXG5pbXBvcnQgTWVzc2FnZSBmcm9tICcuL2NvbXBvbmVudHMvTWVzc2FnZSc7XHJcbmltcG9ydCBSZXN1bHQgZnJvbSAnLi9jb21wb25lbnRzL1Jlc3VsdCc7XHJcbmltcG9ydCB1c2VSZXN1bHRzU3R5bGVzIGZyb20gJy4vc3R5bGVzJztcclxuY29uc3QgUmVzdWx0cyA9IChwcm9wcykgPT4ge1xyXG4gICAgY29uc3QgeyByZXN1bHRzOiByYXdSZXN1bHRzLCBzZWFyY2hpbmcsIGZpZWxkcywgZXJyb3IgfSA9IHVzZVNlYXJjaENvbnRleHQoKTtcclxuICAgIGNvbnN0IHJlc3VsdHMgPSBSZWFjdC51c2VNZW1vKCgpID0+IChyYXdSZXN1bHRzID8gbWFwUmVzdWx0RmllbGRzKHJhd1Jlc3VsdHMsIGZpZWxkcykgOiB1bmRlZmluZWQpLCBbXHJcbiAgICAgICAgcmF3UmVzdWx0cyxcclxuICAgIF0pO1xyXG4gICAgY29uc3QgeyBkaXNhYmxlRGVmYXVsdFN0eWxlcyA9IGZhbHNlLCBjdXN0b21DbGFzc05hbWVzLCB2aWV3VHlwZSwgc2V0Vmlld1R5cGUgfSA9IHVzZVNlYXJjaFVJQ29udGV4dCgpO1xyXG4gICAgY29uc3QgeyBxdWVyeSB9ID0gdXNlUXVlcnkoKTtcclxuICAgIGNvbnN0IHsgZGVmYXVsdEFwcGVhcmFuY2UsIGFwcGVhcmFuY2UgPSB2aWV3VHlwZSwgc3R5bGVzOiBzdHlsZXNQcm9wLCAuLi5yZXN0IH0gPSBwcm9wcztcclxuICAgIGNvbnN0IFt3aWR0aCwgc2V0V2lkdGhdID0gUmVhY3QudXNlU3RhdGUoMCk7XHJcbiAgICBjb25zdCB7IGhhbmRsZVJlc3VsdENsaWNrZWQgfSA9IHVzZVRyYWNraW5nKCk7XHJcbiAgICBjb25zdCBoYXNJbWFnZXMgPSBSZWFjdC51c2VNZW1vKCgpID0+IHJlc3VsdHM/LnNvbWUoKHIpID0+IHIudmFsdWVzPy5pbWFnZSksIFtyZXN1bHRzXSk7XHJcbiAgICBjb25zdCBzdHlsZXMgPSBnZXRTdHlsZXNPYmplY3QodXNlUmVzdWx0c1N0eWxlcyh7IC4uLnByb3BzLCBhcHBlYXJhbmNlLCB3aWR0aCB9KSwgZGlzYWJsZURlZmF1bHRTdHlsZXMpO1xyXG4gICAgY29uc3QgeyB0IH0gPSB1c2VUcmFuc2xhdGlvbihbJ2NvbW1vbicsICdlcnJvcnMnLCAncmVzdWx0J10pO1xyXG4gICAgUmVhY3QudXNlRWZmZWN0KCgpID0+IHtcclxuICAgICAgICBpZiAoZGVmYXVsdEFwcGVhcmFuY2UpIHtcclxuICAgICAgICAgICAgc2V0Vmlld1R5cGUoZGVmYXVsdEFwcGVhcmFuY2UpO1xyXG4gICAgICAgIH1cclxuICAgIH0sIFtdKTtcclxuICAgIGlmIChlcnJvcikge1xyXG4gICAgICAgIGxldCBib2R5ID0gdCgnZXJyb3JzOmdlbmVyaWMnKTtcclxuICAgICAgICBpZiAoZXJyb3Iuc3RhdHVzQ29kZSA9PT0gNDAzKSB7XHJcbiAgICAgICAgICAgIGJvZHkgPSB0KCdlcnJvcnM6YXV0aG9yaXphdGlvbicpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIGlmIChlcnJvci5uYW1lID09PSAnTmV0d29ya0Vycm9yJyB8fCBlcnJvci5tZXNzYWdlLnN0YXJ0c1dpdGgoJ05ldHdvcmtFcnJvcicpKSB7XHJcbiAgICAgICAgICAgIGJvZHkgPSB0KCdlcnJvcnM6Y29ubmVjdGlvbicpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gPE1lc3NhZ2UgdGl0bGU9e3QoJ2NvbW1vbjplcnJvcicpfSBib2R5PXtib2R5fSBjbGFzc05hbWU9e2N1c3RvbUNsYXNzTmFtZXMucmVzdWx0cz8uZXJyb3JNZXNzYWdlfS8+O1xyXG4gICAgfVxyXG4gICAgaWYgKGlzTnVsbE9yVW5kZWZpbmVkKHJlc3VsdHMpKSB7XHJcbiAgICAgICAgcmV0dXJuICg8TWVzc2FnZSB0aXRsZT17dCgnY29tbW9uOmxvYWRpbmcnKX0gYXBwZWFyYW5jZT1cImxvYWRpbmdcIiBkaXNhYmxlRGVmYXVsdFN0eWxlcz17ZGlzYWJsZURlZmF1bHRTdHlsZXN9IGNsYXNzTmFtZT17Y3VzdG9tQ2xhc3NOYW1lcy5yZXN1bHRzPy5zZWFyY2hpbmdNZXNzYWdlfS8+KTtcclxuICAgIH1cclxuICAgIGlmIChpc0VtcHR5KHJlc3VsdHMpKSB7XHJcbiAgICAgICAgaWYgKHNlYXJjaGluZykge1xyXG4gICAgICAgICAgICByZXR1cm4gKDxNZXNzYWdlIHRpdGxlPXt0KCdjb21tb246bG9hZGluZycpfSBhcHBlYXJhbmNlPVwibG9hZGluZ1wiIGRpc2FibGVEZWZhdWx0U3R5bGVzPXtkaXNhYmxlRGVmYXVsdFN0eWxlc30gY2xhc3NOYW1lPXtjdXN0b21DbGFzc05hbWVzLnJlc3VsdHM/LnNlYXJjaGluZ01lc3NhZ2V9Lz4pO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gKDxNZXNzYWdlIHRpdGxlPXt0KCdyZXN1bHRzOmVtcHR5LnRpdGxlJyl9IGJvZHk9e3QoJ3Jlc3VsdHM6ZW1wdHkuYm9keScsIHsgcXVlcnk6IGA8c3Ryb25nPiR7cXVlcnl9PC9zdHJvbmc+YCB9KX0gZGlzYWJsZURlZmF1bHRTdHlsZXM9e2Rpc2FibGVEZWZhdWx0U3R5bGVzfSBjbGFzc05hbWU9e2N1c3RvbUNsYXNzTmFtZXMucmVzdWx0cz8uZW1wdHlNZXNzYWdlfS8+KTtcclxuICAgIH1cclxuICAgIHJldHVybiAoPFJlc2l6ZU9ic2VydmVyIG9uUmVzaXplPXsocmVjdCkgPT4gc2V0V2lkdGgocmVjdC53aWR0aCl9IGNzcz17W3N0eWxlcy5jb250YWluZXIsIHN0eWxlc1Byb3BdfSBjbGFzc05hbWU9e2N1c3RvbUNsYXNzTmFtZXMucmVzdWx0cz8uY29udGFpbmVyfT5cbiAgICAgIHtyZXN1bHRzPy5tYXAoKHsgdmFsdWVzLCB0b2tlbiB9LCBpKSA9PiAoPFJlc3VsdCBvbkNsaWNrPXtoYW5kbGVSZXN1bHRDbGlja2VkfSB0b2tlbj17dG9rZW59IGtleT17dmFsdWVzLl9pZCA/PyBpfSB2YWx1ZXM9e3ZhbHVlc30gYXBwZWFyYW5jZT17YXBwZWFyYW5jZX0gZm9yY2VJbWFnZT17aGFzSW1hZ2VzfSBkaXNhYmxlRGVmYXVsdFN0eWxlcz17ZGlzYWJsZURlZmF1bHRTdHlsZXN9IGNsYXNzTmFtZT17Y3VzdG9tQ2xhc3NOYW1lcy5yZXN1bHRzPy5pdGVtfSBoZWFkaW5nQ2xhc3NOYW1lPXtjdXN0b21DbGFzc05hbWVzLnJlc3VsdHM/LmhlYWRpbmd9IGRlc2NyaXB0aW9uQ2xhc3NOYW1lPXtjdXN0b21DbGFzc05hbWVzLnJlc3VsdHM/LmRlc2NyaXB0aW9ufSBwcmljZUNsYXNzTmFtZT17Y3VzdG9tQ2xhc3NOYW1lcy5yZXN1bHRzPy5wcmljZX0gcmF0aW5nQ2xhc3NOYW1lPXtjdXN0b21DbGFzc05hbWVzLnJlc3VsdHM/LnJhdGluZ30gc3ViVGl0bGVDbGFzc05hbWU9e2N1c3RvbUNsYXNzTmFtZXMucmVzdWx0cz8uc3ViVGl0bGV9IHsuLi5yZXN0fS8+KSl9XG4gICAgPC9SZXNpemVPYnNlcnZlcj4pO1xyXG59O1xyXG5leHBvcnQgZGVmYXVsdCBSZXN1bHRzO1xyXG4vLyMgc291cmNlTWFwcGluZ1VSTD1pbmRleC5qc3gubWFwIl19 */")),
    className: (_customClassNames$res5 = customClassNames.results) == null ? void 0 : _customClassNames$res5.container,
    children: results == null ? void 0 : results.map(function (_ref, i) {
      var _values$_id, _customClassNames$res6, _customClassNames$res7, _customClassNames$res8, _customClassNames$res9, _customClassNames$res10, _customClassNames$res11;

      var values = _ref.values,
          token = _ref.token;
      return jsx(Result, _extends({
        onClick: handleResultClicked,
        token: token,
        values: values,
        appearance: appearance,
        forceImage: hasImages,
        disableDefaultStyles: disableDefaultStyles,
        className: (_customClassNames$res6 = customClassNames.results) == null ? void 0 : _customClassNames$res6.item,
        headingClassName: (_customClassNames$res7 = customClassNames.results) == null ? void 0 : _customClassNames$res7.heading,
        descriptionClassName: (_customClassNames$res8 = customClassNames.results) == null ? void 0 : _customClassNames$res8.description,
        priceClassName: (_customClassNames$res9 = customClassNames.results) == null ? void 0 : _customClassNames$res9.price,
        ratingClassName: (_customClassNames$res10 = customClassNames.results) == null ? void 0 : _customClassNames$res10.rating,
        subTitleClassName: (_customClassNames$res11 = customClassNames.results) == null ? void 0 : _customClassNames$res11.subTitle
      }, rest), (_values$_id = values._id) != null ? _values$_id : i);
    })
  });
};

export default Results;
//# sourceMappingURL=index.esm.js.map
